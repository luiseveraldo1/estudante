<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor Minimalista</title>
<style>
body {
  font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f2f4f7;
  color: #222;
  margin: 0;
  padding: 30px;
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: background 0.3s;
}

h2 { margin-bottom: 5px; color: #2c3e50; }
h3 { margin: 20px 0 10px; color: #34495e; }

#searchInput {
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid #ccc;
  min-width: 220px;
  font-size: 15px;
  background: #fff;
  transition: all 0.2s ease;
}
#searchInput:focus {
  outline: none;
  border-color: #4a90e2;
  box-shadow: 0 0 8px rgba(74,144,226,0.2);
}

textarea {
  width: 100%;
  max-width: 820px;
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 12px 14px;
  resize: vertical;
  font-size: 16px;
  background: #fff;
  transition: box-shadow 0.3s, border-color 0.3s;
}
textarea:focus {
  outline: none;
  border-color: #4a90e2;
  box-shadow: 0 0 10px rgba(74,144,226,0.25);
}

#processedText {
  width: 100%;
  max-width: 820px;
  height: 140px;
  margin-top: 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  padding: 12px 14px;
  font-size: 16px;
  background: #fff;
  resize: vertical;
  transition: all 0.2s ease;
}
#processedText:focus {
  outline: none;
  border-color: #27ae60;
  box-shadow: 0 0 10px rgba(39,174,96,0.25);
}

button, input, select {
  margin: 6px;
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
  font-size: 15px;
  font-family: inherit;
  transition: all 0.2s ease;
}

button { background: #4a90e2; color: #fff; border: none; font-weight: 500; }
button:hover { background: #357ABD; transform: translateY(-1px); }

.controls { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 15px; }
.controls button, .controls select, .controls input { margin: 6px; }

#output {
  border-radius: 16px;
  padding: 40px;
  margin-top: 20px;
  min-height: 160px;
  width: 100%;
  max-width: 820px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  text-align: center;
  background: #ffffff;
  box-shadow: 0 6px 20px rgba(0,0,0,0.06);
  transition: opacity 0.5s, transform 0.3s;
}

.motivation {
  color: #27ae60;
  font-weight: bold;
  animation: blink 0.6s ease-in-out 2;
}

@keyframes blink {
  0%,100% { opacity: 1; }
  50% { opacity: 0.4; }
}
</style>
</head>
<body>

<h2>Leitor Minimalista</h2>

<h3>Texto Bruto</h3>
<textarea id="rawText" rows="6" placeholder="Cole seu texto aqui..."></textarea><br>

<div class="controls">
  <button onclick="generateSentences()">📌 Gerar frases</button>
  <button onclick="generateSmartSummary()">📝 Resumo inteligente</button>
  <button onclick="clearRawText()">🗑️ Limpar</button>
  <input type="text" id="searchInput" placeholder="Pesquisar no Google...">
  <button onclick="searchGoogle()">🔍 Pesquisar Google</button>
  <button onclick="importFromLink()">📎 Importar texto de link</button>
</div>

<h3>Texto Processado</h3>
<textarea id="processedText" placeholder="Frases extraídas ou resumidas aparecerão aqui..."></textarea>
<button onclick="syncProcessedText()">🔄 Atualizar do Processado</button>

<h3>Configurações de Fonte</h3>
<div class="controls">
  <label>Tamanho: <input type="number" id="fontSize" value="24" min="12" max="60"></label>
  <label>Cor: <input type="color" id="fontColor" value="#111111"></label>
  <label>Fonte:
    <select id="fontFamily">
      <option value="Arial">Arial</option>
      <option value="Georgia">Georgia</option>
      <option value="Courier New">Courier New</option>
      <option value="Verdana">Verdana</option>
      <option value="Times New Roman">Times New Roman</option>
    </select>
  </label>
</div>

<h3>Voz</h3>
<div class="controls">
  <select id="voiceSelect"></select>
  <button onclick="toggleVoice()">🔊 Ativar/Desativar Voz</button>
  <label>Velocidade: 
    <input type="number" id="voiceRate" value="1" min="0.1" max="3" step="0.1" style="width:60px">
  </label>
</div>

<h3>Frases Motivacionais</h3>
<div class="controls">
  <label>Inserir a cada <input type="number" id="motivationEvery" value="0" min="0" style="width:50px"> frases (0 = desativado)</label>
</div>

<div id="output">Aguardando texto...</div>

<div class="controls">
  <button onclick="startAuto()">▶️ Automático</button>
  <button onclick="pauseAuto()">⏸️ Pausar</button>
  <button onclick="resetReader()">🔄 Reset</button>
  <button onclick="manualMode()">📖 Controle Manual</button>
  <button onclick="prevSentence()">⬅️ Voltar</button>
  <button onclick="nextSentence()">➡️ Avançar</button>
</div>

<h3>Gerenciamento de Textos</h3>
<div class="controls">
  <button onclick="exportJSON()">💾 Exportar JSON</button>
  <button onclick="saveToCloud()">☁️ Salvar na Nuvem</button>
  <button onclick="copyCloudLink()">🔗 Copiar Link</button>
  <button onclick="loadFromCloud()">📥 Carregar da Nuvem</button>
  <input type="file" id="importFile" onchange="importJSON(event)">
</div>

<script>
let sentences=[], currentIndex=0, autoMode=false, voiceEnabled=false;
let voices=[], selectedVoice=null, textReadCounts={};
let cloudLink = "";
const output=document.getElementById('output'), voiceSelect=document.getElementById('voiceSelect');
const motivationalPhrases=[
  "Continue firme, você está indo bem!",
  "Mais uma frase! Foque e avance!",
  "Você está se superando a cada leitura!",
  "Mantenha o ritmo, sua mente agradece!",
  "A constância traz o resultado!",
  "Respire fundo, você está no caminho certo!",
  "Seu foco está criando resultados!"
];

// ===== Vozes =====
function loadVoices(){
  voices=speechSynthesis.getVoices();
  voiceSelect.innerHTML="";
  voices.forEach((v,i)=>{
    let o=document.createElement("option"); o.value=i; o.textContent=`${v.name} (${v.lang})`; voiceSelect.appendChild(o);
  });
  if(voices.length>0) selectedVoice=voices[0];
}
speechSynthesis.onvoiceschanged=loadVoices;
voiceSelect.addEventListener("change",()=>{ selectedVoice=voices[voiceSelect.value]; });

// ===== Funções de Texto =====
function generateSentences(){
  const text=document.getElementById('rawText').value;
  if(!text.trim()) return;
  sentences=text.split(/(?<=\.)\s+/).map(s=>s.trim()).filter(Boolean);
  sentences=insertMotivation(sentences);
  currentIndex=0;
  document.getElementById('processedText').value=sentences.join("\n\n");
  showCurrent();
}

function generateSmartSummary(){
  const text = document.getElementById('rawText').value;
  if(!text.trim()) return;
  const stopwords=["de","do","da","e","a","o","que","em","um","uma","para","com","não","se","por","os","as","no","na","dos","das"];
  const sents = text.split(/(?<=\.)\s+/).map(s => s.trim()).filter(Boolean);
  const freq = {};
  sents.forEach(s => { s.split(/\s+/).forEach(w => { const word = w.toLowerCase().replace(/[.,!?]/g,''); if(!stopwords.includes(word)) freq[word]=(freq[word]||0)+1; }); });
  const scored = sents.map(s => { const score = s.split(/\s+/).reduce((a,w)=>{ const word=w.toLowerCase().replace(/[.,!?]/g,''); return a+(freq[word]||0); },0); return {text:s,score}; });
  scored.sort((a,b)=>b.score-a.score);
  const summary = scored.slice(0,Math.min(5,scored.length)).map(s=>s.text);
  sentences=insertMotivation(summary);
  currentIndex=0;
  document.getElementById('processedText').value=sentences.join("\n\n");
  showCurrent();
}

function syncProcessedText(){
  const edited=document.getElementById('processedText').value;
  sentences=edited.split(/\n\s*\n/).map(s=>s.trim()).filter(Boolean);
  currentIndex=0;
  showCurrent();
}

function insertMotivation(arr){
  const every=parseInt(document.getElementById('motivationEvery').value)||0;
  if(every<=0) return arr;
  let final=[];
  for(let i=0;i<arr.length;i++){
    final.push(arr[i]);
    if((i+1)%every===0 && i!==arr.length-1){
      final.push(motivationalPhrases[Math.floor(Math.random()*motivationalPhrases.length)]);
    }
  }
  return final;
}

function clearRawText(){
  document.getElementById('rawText').value="";
  document.getElementById('processedText').value="";
  sentences=[];
  output.textContent="Texto apagado.";
}

function searchGoogle(){
  const q=document.getElementById('searchInput').value.trim();
  if(q) window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, "_blank");
  else { alert("Digite algo para pesquisar."); document.getElementById('searchInput').focus(); }
}

async function importFromLink(){
  const url=prompt("Cole o link do site (modo texto recomendado):");
  if(!url) return;
  try{
    const res=await fetch(`http://localhost:3000/extract-text?url=${encodeURIComponent(url)}`);
    const data=await res.json();
    if(data.text) { document.getElementById('rawText').value=data.text; alert("Texto extraído com sucesso!"); }
    else alert("Não foi possível extrair o texto.");
  }catch(err){ alert("Erro ao importar o texto: "+err.message); }
}

// ===== Mostrar Frase =====
function showCurrent(){
  if(!sentences.length){output.textContent="Nenhuma frase gerada."; return;}
  output.style.fontSize=document.getElementById('fontSize').value+"px";
  output.style.color=document.getElementById('fontColor').value;
  output.style.fontFamily=document.getElementById('fontFamily').value;
  const text=sentences[currentIndex];
  if(motivationalPhrases.includes(text)) output.innerHTML=`<span class="motivation">${text}</span>`;
  else output.textContent=text;
}

function speakCurrent(){
  const text=sentences[currentIndex];
  if(!voiceEnabled||!selectedVoice){ if(autoMode) nextSentenceAuto(); return; }
  speechSynthesis.cancel();
  const utter=new SpeechSynthesisUtterance(text);
  utter.voice=selectedVoice;
  utter.rate=parseFloat(document.getElementById('voiceRate').value)||1;
  utter.onend=()=>{ incrementReadCount(document.getElementById('rawText').value); if(autoMode) nextSentenceAuto(); };
  speechSynthesis.speak(utter);
}

function incrementReadCount(text){
  const hash=hashCode(text);
  textReadCounts[hash]=(textReadCounts[hash]||0)+1;
}

function hashCode(str){let hash=0; for(let i=0;i<str.length;i++){hash=((hash<<5)-hash)+str.charCodeAt(i);hash|=0;} return hash;}

// ===== Controle Automático =====
function startAuto(){ if(!sentences.length) return; autoMode=true; currentIndex=0; showCurrent(); speakCurrent(); }
function nextSentenceAuto(){ if(!autoMode||!sentences.length) return; currentIndex=(currentIndex+1)%sentences.length; showCurrent(); speakCurrent(); }
function pauseAuto(){ autoMode=false; speechSynthesis.cancel(); }
function resetReader(){ pauseAuto(); currentIndex=0; showCurrent(); }
function manualMode(){ pauseAuto(); showCurrent(); }
function nextSentence(){ currentIndex=(currentIndex+1)%sentences.length; showCurrent(); if(voiceEnabled) speakCurrent(); }
function prevSentence(){ currentIndex=(currentIndex-1+sentences.length)%sentences.length; showCurrent(); if(voiceEnabled) speakCurrent(); }
function toggleVoice(){ voiceEnabled=!voiceEnabled; alert("Voz "+(voiceEnabled?"ativada":"desativada")); }

// ===== Export/Import JSON Local =====
function exportJSON(){ const data={sentences,textReadCounts}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='memo22_textData.json'; a.click(); URL.revokeObjectURL(url);}
function importJSON(event){ const file=event.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=(e)=>{ try{ const data=JSON.parse(e.target.result); if(data.sentences) sentences=data.sentences; if(data.textReadCounts) textReadCounts=data.textReadCounts; currentIndex=0; document.getElementById('processedText').value=sentences.join("\n\n"); showCurrent(); alert("JSON importado com sucesso!"); }catch(err){alert("Erro ao importar JSON: "+err);}}; reader.readAsText(file);}

// ===== JSONBin.io Cloud Functions =====
async function saveToCloud(){
  const data={sentences,textReadCounts};
  try{
    const res=await fetch("https://api.jsonbin.io/v3/b",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Master-Key":"$2a$10$2wR5NQoVsUWczmL.U8MAs.YILi4/aKD3YK01iPbnyFzfLn.xiChGK",
        "X-Bin-Private":"false"
      },
      body:JSON.stringify(data)
    });
    const json=await res.json();
    console.log("JSONBin resposta:",json);
    if(json && json.metadata && json.metadata.id){
      cloudLink=`https://jsonbin.io/b/${json.metadata.id}`;
      alert("JSON salvo na nuvem com sucesso!\nLink: "+cloudLink);
    } else {
      alert("JSON salvo, mas não foi possível gerar link automaticamente. Veja console.");
      console.log(json);
    }
  }catch(err){ alert("Erro ao salvar na nuvem: "+err.message); console.error(err); }
}

function copyCloudLink(){
  if(!cloudLink){ 
    alert("Nenhum JSON salvo ainda."); 
    return; 
  }

  const urlWeb = "https://jsonbin.io/b/" + cloudLink;         // visualização web
  const urlRaw = "https://api.jsonbin.io/v3/b/" + cloudLink + "/latest"; // JSON puro

  const message = 
    "Links disponíveis:\n\n" +
    "1️⃣ Web: " + urlWeb + "\n" +
    "2️⃣ JSON: " + urlRaw + "\n\n" +
    "Digite 1 para copiar o Web ou 2 para copiar o JSON:";

  const choice = prompt(message, "1");

  let url;
  if(choice === "2"){
    url = urlRaw;
  } else {
    url = urlWeb;
  }

  navigator.clipboard.writeText(url)
    .then(()=>alert("Link copiado!\n" + url))
    .catch(()=>alert("Falha ao copiar link."));
}


async function loadFromCloud(){
  const url=prompt("Cole o link do JSONBin.io:");
  if(!url) return;
  try{
    const id=url.split("/").pop();
    const res=await fetch(`https://api.jsonbin.io/v3/b/${id}/latest`,{
      headers:{ "X-Master-Key":"$2a$10$2wR5NQoVsUWczmL.U8MAs.YILi4/aKD3YK01iPbnyFzfLn.xiChGK" }
    });
    const json=await res.json();
    console.log("JSONBin load resposta:",json);
    if(json && json.record){
      sentences=json.record.sentences||[];
      textReadCounts=json.record.textReadCounts||{};
      currentIndex=0;
      document.getElementById('processedText').value=sentences.join("\n\n");
      showCurrent();
      alert("JSON carregado da nuvem com sucesso!");
    } else { alert("Não foi possível carregar JSON. Veja console."); console.log(json); }
  }catch(err){ alert("Erro ao carregar JSON: "+err.message); console.error(err); }
}
</script>
</body>
</html>
